#!/usr/bin/env guile
!#

(use-modules
 (srfi srfi-1)
 (ice-9 textual-ports)
 (ice-9 popen))

(define (ensure-flatpak remotes packages)
  (define (ensure-remote spec)
    (system* "flatpak" "--user" "remote-add" "--if-not-exists"
             (car spec) (cdr spec)))

  (define (ensure-packages spec)
    (let ((remote (car spec))
          (packages (cdr spec)))
      (apply system* "flatpak" "--user" "install" "-y" remote packages)))

  (for-each ensure-remote remotes)
  (for-each ensure-packages packages)

  (define (remove-flatpak pkg)
    (apply system* "flatpak" "--user" "uninstall" "-y" pkg))
  (define installed
    (string-split
     (string-trim-both
      (get-string-all
       (open-pipe* OPEN_READ "flatpak" "--user" "list" "--app" "--columns=application")))
     #\newline))
  (define to-uninstall
    (lset-difference string=
                     installed
                     (append-map cdr packages)))
  (if (not (null? to-uninstall))
      (remove-flatpak to-uninstall)))

(ensure-flatpak
 '(("flathub" . "https://dl.flathub.org/repo/flathub.flatpakrepo"))
 '(("flathub"
    "com.sindresorhus.Caprine"
    "com.discordapp.Discord"
    "com.github.IsmaelMartinez.teams_for_linux"
    "org.zotero.Zotero"
    "im.riot.Riot"
    "net.ankiweb.Anki"
    "com.github.tchx84.Flatseal"
    "com.jetbrains.CLion"
    "com.spotify.Client"
    "com.jetbrains.IntelliJ-IDEA-Ultimate"
    "io.github.mimbrero.WhatsAppDesktop"
    "com.felipekinoshita.Wildcard"
    "com.github.johnfactotum.Foliate"
    "com.usebottles.bottles"
    "com.visualstudio.code"
    "de.haeckerfelix.Shortwave"
    "md.obsidian.Obsidian"
    "org.geogebra.GeoGebra"
    "org.ghidra_sre.Ghidra"
    "rest.insomnia.Insomnia"
    )))

;; Local Variables:
;; mode: scheme
;; End:
