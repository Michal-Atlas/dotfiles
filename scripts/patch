#!/usr/bin/env -S guix repl --
!#

(use-modules (srfi srfi-26) (srfi srfi-1))

(define (main . args)
  (map (lambda (target)
	 (system* "patchelf" target "--set-rpath"
		  (string-append
		   "/run/current-system/profile/lib:/home/"
		   (getlogin)
		   "/.guix-home/profile/lib"
		   (apply string-append
			  (map (cut string-append ":" <> "/lib")
			       (drop-right (string-split
				 ((@ (ice-9 textual-ports) get-string-all)
				  ((@ (ice-9 popen) open-pipe*)
				   OPEN_READ "guix" "package" "--list-profiles"))
				 #\newline) 1)))))
	 
	 (system*
	  "patchelf" target
	  "--set-interpreter"
	  "/run/current-system/profile/lib/ld-linux-x86-64.so.2")
	 
	 (display (format #t "RPATH: ~aLD: ~a"
			  ((@ (ice-9 textual-ports) get-string-all)
			   ((@ (ice-9 popen) open-pipe*)
			    OPEN_READ "patchelf" target "--print-rpath"))
			  ((@ (ice-9 textual-ports) get-string-all)
			   ((@ (ice-9 popen) open-pipe*)
			    OPEN_READ "patchelf" target "--print-interpreter")))))
       args))

(apply main (cdr (command-line)))

;; Local Variables:
;; mode: scheme
;; End:
